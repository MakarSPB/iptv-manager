<!DOCTYPE html>
<html>
<head>
    <title>IPTV Playlist Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à M3U –ø–ª–µ–π–ª–∏—Å—Ç</h1>
    <input type="file" id="file" accept=".m3u,.m3u8">
    <button onclick="upload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <div id="editor" style="display:none; margin-top:20px;">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤</h2>
        <table id="channel-table" border="1">
            <tr><th>–ò–º—è</th><th>–õ–æ–≥–æ—Ç–∏–ø</th><th>–ì—Ä—É–ø–ø–∞</th><th>URL</th><th>–£–¥–∞–ª–∏—Ç—å</th></tr>
        </table>
        <button onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
        <p id="result-url"></p>
    </div>

    <script>
        let playlistId = null;

        async function upload() {
            const input = document.getElementById('file');
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            const res = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            playlistId = data.playlist_id;
            renderChannels(data.channels);
            document.getElementById('editor').style.display = 'block';
        }

        function renderChannels(channels) {
            const table = document.getElementById('channel-table');
            // –û—á–∏—â–∞–µ–º, –∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            while (table.rows.length > 1) table.deleteRow(1);

            channels.forEach((ch, i) => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td><input value="${escapeHtml(ch.name)}"></td>
                    <td><input size="10" value="${escapeHtml(ch.tvg_logo || '')}"></td>
                    <td><input size="10" value="${escapeHtml(ch.group_title || '')}"></td>
                    <td><input size="20" value="${escapeHtml(ch.url)}"></td>
                    <td><button onclick="removeRow(this)">‚ùå</button></td>
                `;
            });
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function save() {
            const table = document.getElementById('channel-table');
            const channels = [];

            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const inputs = row.querySelectorAll('input');
                channels.push({
                    name: inputs[0].value,
                    tvg_logo: inputs[1].value || null,
                    group_title: inputs[2].value || null,
                    url: inputs[3].value
                });
            }

            const res = await fetch(`/save/${playlistId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(channels)
            });
            const data = await res.json();
            document.getElementById('result-url').innerHTML =
                `üîó –í–∞—à –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç: <a href="${data.url}" target="_blank">${data.url}</a>`;
        }
    </script>
</body>
</html>