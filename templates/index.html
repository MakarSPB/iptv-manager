<!DOCTYPE html>
<html>
<head>
    <title>–ì–ª–∞–≤–Ω–∞—è</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<h1>üé• IPTV Playlist Manager</h1>
<p>–ü—Ä–∏–≤–µ—Ç, <strong>{{ user.username }}</strong>! <a href="/logout">–í—ã—Ö–æ–¥</a></p>

<h2>üìÅ –ú–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</h2>
<table border="1" width="100%">
    <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–§–∞–π–ª</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    {% for pl in playlists %}
    <tr>
        <td>{{ pl.id }}</td>
        <td>{{ pl.name }}</td>
        <td>{{ pl.filename }}</td>
        <td>
            <a href="/playlists/{{ pl.id }}.m3u" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a> |
            <a href="/playlists/{{ pl.id }}.m3u" download>–°–∫–∞—á–∞—Ç—å</a>
        </td>
    </tr>
    {% else %}
    <tr><td colspan="4">–ü–æ–∫–∞ –Ω–µ—Ç –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤</td></tr>
    {% endfor %}
</table>

<hr>
<h2>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</h2>
<input type="file" id="file" accept=".m3u,.m3u8">
<button onclick="upload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

<div id="editor" style="display:none; margin-top:20px;">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <span id="playlist-name">–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</span></h3>
    <table id="channel-table" border="1" width="100%">
        <tr><th>–ò–º—è</th><th>–õ–æ–≥–æ—Ç–∏–ø</th><th>–ì—Ä—É–ø–ø–∞</th><th>URL</th><th>–£–¥–∞–ª–∏—Ç—å</th></tr>
    </table>
    <input type="text" id="save-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞" value="–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç">
    <button onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <p id="result-url"></p>
</div>

<script>
    let playlistId = null;
    let channels = [];

    async function upload() {
        const input = document.getElementById('file');
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        playlistId = null;
        channels = data.channels;
        document.getElementById('playlist-name').textContent = file.name;
        renderChannels(channels);
        document.getElementById('editor').style.display = 'block';
    }

    function renderChannels(chs) {
        const table = document.getElementById('channel-table');
        while (table.rows.length > 1) table.deleteRow(1);
        chs.forEach(ch => {
            const row = table.insertRow();
            row.innerHTML = `
                <td><input value="${escapeHtml(ch.name)}"></td>
                <td><input size="10" value="${escapeHtml(ch.tvg_logo || '')}"></td>
                <td><input size="10" value="${escapeHtml(ch.group_title || '')}"></td>
                <td><input size="20" value="${escapeHtml(ch.url)}"></td>
                <td><button onclick="removeRow(this)">‚ùå</button></td>
            `;
        });
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function save() {
        const name = document.getElementById('save-name').value || '–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç';
        const table = document.getElementById('channel-table');
        const updatedChannels = [];
        for (let i = 1; i < table.rows.length; i++) {
            const row = table.rows[i];
            const inputs = row.querySelectorAll('input');
            updatedChannels.push({
                name: inputs[0].value,
                tvg_logo: inputs[1].value || null,
                group_title: inputs[2].value || null,
                url: inputs[3].value
            });
        }

        const res = await fetch(`/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, channels: updatedChannels })
        });
        const data = await res.json();
        document.getElementById('result-url').innerHTML =
            `üîó –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: <a href="${data.url}" target="_blank">${data.url}</a>`;
    }
</script>
</body>
</html>