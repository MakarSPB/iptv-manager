<!DOCTYPE html>
<html>
<head>
    {% include "partials/metadata.html" %}
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - IPTV Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<nav>
    <div class="logo"><a href="/">IPTV Manager</a></div>
    <div class="links">
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/playlists">–ú–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</a>
        <a href="/shared">–û–±—â–∞–∫</a>
        <a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
        {% if user.is_admin %}
            <a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        {% endif %}
        <a href="/logout">–í—ã—Ö–æ–¥</a>
    </div>
</nav>

<div class="container">
    <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>

    <form method="post" action="/users" onsubmit="return validateForm()">
        <div class="form-group">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input type="text" name="username" required minlength="3" maxlength="50">
        </div>
        <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" name="password" required minlength="6">
        </div>
        <div class="form-group">
            <label>–≠–ª. –ø–æ—á—Ç–∞:</label>
            <input type="email" name="email" required>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_admin" value="true"> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            </label>
        </div>
        <button type="submit" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </form>

    <hr>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <form id="editUserForm" onsubmit="return saveUserEdit(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="editUsername" required minlength="3" maxlength="50">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å):</label>
                    <input type="password" id="editPassword" minlength="6">
                </div>
                <div class="form-group">
                    <label>–≠–ª. –ø–æ—á—Ç–∞:</label>
                    <input type="email" id="editEmail" required>
                </div>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>

    <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
    {% if users %}
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>–ò–º—è</th>
            <th>Email</th>
            <th>–ê–¥–º–∏–Ω</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody>
        {% for u in users %}
        <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.email or "‚Äî "}}</td>
            <td>
                <label class="admin-toggle">
                    <input type="checkbox" {% if u.is_admin %}checked{% endif %} onchange="toggleAdmin({{ u.id }}, this.checked)">
                    <span class="slider"></span>
                </label>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-edit" onclick="editUser({{ u.id }}, '{{ u.username }}', '{{ u.email }}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    {% if not u.is_admin %}
                    <button class="btn btn-danger" onclick="deleteUser({{ u.id }})">–£–¥–∞–ª–∏—Ç—å</button>
                    {% else %}
                    <span class="admin-only">–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å</span>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <h3>‚úÖ –£—Å–ø–µ—à–Ω–æ!</h3>
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω</p>
        <button class="modal-btn" onclick="closeModal()">–î–∞–ª–µ–µ</button>
    </div>
</div>

<script>
    async function editUser(userId, username, email) {
        document.getElementById('editUserId').value = userId;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editPassword').value = '';
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveUserEdit(event) {
        event.preventDefault();
        
        const userId = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value;
        const password = document.getElementById('editPassword').value;
        const email = document.getElementById('editEmail').value;
        
        try {
            const formData = new FormData();
            formData.append('username', username);
            if (password) formData.append('password', password);
            formData.append('email', email);
            
            const res = await fetch(`/users/${userId}/edit`, {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                alert('–û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
        }
        
        return false;
    }

    async function toggleAdmin(userId, isAdmin) {
        try {
            const res = await fetch(`/users/${userId}/admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({is_admin: isAdmin})
            });
            if (!res.ok) {
                const data = await res.json();
                alert('–û—à–∏–±–∫–∞: ' + data.detail);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                event.target.checked = !isAdmin;
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
            event.target.checked = !isAdmin;
        }
    }

    function validateForm() {
        const username = document.querySelector("input[name='username']").value;
        if (username.includes(' ')) {
            alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª–æ–≤");
            return false;
        }
        return true;
    }

    async function deleteUser(userId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) return;

        try {
            const res = await fetch(`/users/${userId}`, {
                method: 'DELETE'
            });
            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                alert('–û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('created') === 'true') {
        document.getElementById('successModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('successModal').style.display = 'none';
        window.location.href = '/users';
    }
</script>
</body>
</html>