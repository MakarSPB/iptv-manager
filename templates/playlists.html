<!DOCTYPE html>
<html>
<head>
    {% include "partials/metadata.html" %}
    <title>–ú–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã - IPTV Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<nav>
    <div class="logo"><strong>IPTV Manager</strong></div>
    <div class="links">
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/playlists">–ú–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</a>
        <a href="/shared">–û–±—â–∞–∫</a>
        <a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
        {% if user.is_admin %}
        <a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        {% endif %}
        <a href="/logout">–í—ã—Ö–æ–¥</a>
    </div>
</nav>

<div class="container">
    <h2>üìÅ –ú–æ–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</h2>
    {% if playlists %}
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–§–∞–π–ª</th>
            <th>–ö–∞–Ω–∞–ª–æ–≤</th>
            <th>–û–±—â–∞–∫</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody>
        {% for item in playlists %}
        <tr>
            <td>{{ item.playlist.id }}</td>
            <td>{{ item.playlist.name }}</td>
            <td>{{ item.playlist.filename }}</td>
            <td>{{ item.channel_count }}</td>
            <td>
                <input type="checkbox"
                       class="share-toggle"
                       data-id="{{ item.playlist.id }}"
                       {% if item.playlist.is_shared %}checked{% endif %}>
            </td>
            <td class="actions">
                <button class="btn btn-edit" onclick="editPlaylist('{{ item.playlist.id }}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <a class="btn btn-download" href="/{{ item.playlist.id }}.m3u" download>–°–∫–∞—á–∞—Ç—å</a>
                <button class="btn btn-delete" onclick="deletePlaylist('{{ item.playlist.id }}')">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π!</p>
    {% endif %}
</div>
<div class="container">
    <div id="editor" style="display:none; margin-top:20px; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <span id="playlist-name">–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</span></h3>

        <!-- –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª" -->
        <button class="btn btn-edit" onclick="addNewChannel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</button>

        <!-- –ò–º–ø–æ—Ä—Ç M3U –∏–∑ —Ç–µ–∫—Å—Ç–∞ -->
        <div style="margin: 10px 0;">
            <h4>üìé –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª—ã –∏–∑ M3U</h4>
            <textarea id="import-area" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .m3u —Ñ–∞–π–ª–∞..." style="width: 100%; height: 100px;"></textarea>
            <button class="btn btn-edit" onclick="importFromText()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <input type="url" id="tvg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ TV-–≥–∏–¥ (url-tvg)" style="width: 100%; padding: 8px; margin: 10px 0;">

        <table id="channel-table">
            <tr>
                <th>‚Ññ</th>
                <th>–ò–º—è</th>
                <th>–õ–æ–≥–æ—Ç–∏–ø</th>
                <th>–ì—Ä—É–ø–ø–∞</th>
                <th>URL</th>
                <th>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</th>
                <th>–£–¥–∞–ª–∏—Ç—å</th>
            </tr>
        </table>
        <input type="text" id="save-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞" value="–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç">
        <button class="btn btn-edit" onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-delete" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
        <p id="result-url"></p>
    </div>
</div>

<script>
    // === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ ===
    let currentPlaylistId = null;
    let channels = [];
    let tvgUrl = "";

    // === –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ ===
    function addNewChannel() {
        channels.push({ name: '–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª', tvg_name: '', logo: '', group_title: '', url: '' });
        renderChannels();
    }

    function renderChannels() {
        const table = document.getElementById('channel-table');
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        while (table.rows.length > 1) {
            table.deleteRow(1);
        }

        channels.forEach((ch, index) => {
            const row = table.insertRow();
            row.insertCell(0).textContent = index + 1;

            const nameCell = row.insertCell(1);
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'channel-input';
            nameInput.value = ch.name || '';
            nameInput.oninput = () => { channels[index].name = nameInput.value; };
            nameCell.appendChild(nameInput);

            const logoCell = row.insertCell(2);
            const logoInput = document.createElement('input');
            logoInput.type = 'text';
            logoInput.className = 'channel-input';
            logoInput.value = ch.logo || '';
            logoInput.oninput = () => { channels[index].logo = logoInput.value; };
            logoCell.appendChild(logoInput);

            const groupCell = row.insertCell(3);
            const groupInput = document.createElement('input');
            groupInput.type = 'text';
            groupInput.className = 'channel-input';
            groupInput.value = ch.group_title || '';
            groupInput.oninput = () => { channels[index].group_title = groupInput.value; };
            groupCell.appendChild(groupInput);

            const urlCell = row.insertCell(4);
            const urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.className = 'channel-input';
            urlInput.value = ch.url || '';
            urlInput.oninput = () => { channels[index].url = urlInput.value; };
            urlCell.appendChild(urlInput);

            // –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
            const moveCell = row.insertCell(5);
            moveCell.className = 'move-controls';
            moveCell.innerHTML = `
                <button class="btn btn-move" onclick="moveUp(${index})" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                <button class="btn btn-move" onclick="moveDown(${index})" ${index === channels.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                <button class="btn btn-move" onclick="moveToTop(${index})">üîù</button>
                <button class="btn btn-move" onclick="moveToBottom(${index})">üîö</button>
            `;

            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
            const delCell = row.insertCell(6);
            delCell.innerHTML = `<button class="btn btn-delete" onclick="removeRow(${index})">‚ùå</button>`;
        });
    }

    function moveUp(index) {
        if (index > 0) {
            [channels[index], channels[index - 1]] = [channels[index - 1], channels[index]];
            renderChannels();
        }
    }

    function moveDown(index) {
        if (index < channels.length - 1) {
            [channels[index], channels[index + 1]] = [channels[index + 1], channels[index]];
            renderChannels();
        }
    }

    function moveToTop(index) {
        const ch = channels.splice(index, 1)[0];
        channels.unshift(ch);
        renderChannels();
    }

    function moveToBottom(index) {
        const ch = channels.splice(index, 1)[0];
        channels.push(ch);
        renderChannels();
    }

    function removeRow(index) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª?')) {
            channels.splice(index, 1);
            renderChannels();
        }
    }

    function cancelEdit() {
        document.getElementById('editor').style.display = 'none';
        currentPlaylistId = null;
        channels = [];
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function importFromText() {
        const text = document.getElementById('import-area').value;
        if (!text.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ M3U');
            return;
        }

        try {
            const response = await fetch('/parse-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: text })
            });
            if (response.ok) {
                const data = await response.json();
                // === –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º, –∞ –Ω–µ –∑–∞–º–µ–Ω—è–µ–º ===
                channels = [...channels, ...data.channels];
                renderChannels();
                document.getElementById('import-area').value = '';
                alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${data.channels.length} –∫–∞–Ω–∞–ª–æ–≤`);
            } else {
                alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
        }
    }

    async function save() {
        const name = document.getElementById('save-name').value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        tvgUrl = document.getElementById('tvg-url').value;
        if (channels.length === 0) {
            alert('–ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            return;
        }

        const m3uContent = `#EXTM3U\n${channels.map(ch => {
            const tvg = ch.tvg_name ? ` tvg-name="${escapeHtml(ch.tvg_name)}"` : '';
            const logo = ch.logo ? ` tvg-logo="${escapeHtml(ch.logo)}"` : '';
            const group = ch.group_title ? ` group-title="${escapeHtml(ch.group_title)}"` : '';
            return `#EXTINF:-1${tvg}${logo}${group},${escapeHtml(ch.name)}\n${escapeHtml(ch.url)}`;
        }).join('\n')}`;

        try {
            const response = await fetch(`/playlists/${currentPlaylistId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, channels, tvg_url: tvgUrl })
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('result-url').innerHTML = `
                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! <a href="${data.url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a> |
                    <a href="${data.url}" download="${name}.m3u">–°–∫–∞—á–∞—Ç—å</a>
                `;
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                location.reload();
            } else {
                const data = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
        }
    }
</script>
<script>
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞ "–û–±—â–∞–∫"
    document.querySelectorAll('.share-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', async function() {
            const playlistId = this.dataset.id;
            const isShared = this.checked;

            try {
                const response = await fetch(`/playlists/${playlistId}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_shared: isShared })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞');
                this.checked = !isShared;
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    async function editPlaylist(id) {
        try {
            const response = await fetch(`/playlists/${id}/edit`);
            if (!response.ok) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç');
            }
            const data = await response.json();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–ª–µ–π–ª–∏—Å—Ç–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            currentPlaylistId = id;
            document.getElementById('save-name').value = data.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã –≤ —Ç–∞–±–ª–∏—Ü–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            channels = data.channels;
            renderChannels();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
            document.getElementById('editor').style.display = 'block';

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
            document.getElementById('editor').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
        }
    }
</script>
<footer style="text-align: center; margin-top: 40px; padding: 10px; font-size: 14px; color: #6c757d;">
    &copy; 2025
    <a href="https://github.com/MakarSPB" target="_blank" style="color: #007bff; text-decoration: none;">
        MakarSPB
    </a>
</footer>
</body>
</html>